{% extends 'base.html' %}

{% block content %}
<ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
    <li class="nav-item">
        <button class="nav-link {% if active_tab == 'home' %}active{% endif %}" 
                data-bs-toggle="tab" data-bs-target="#home">ğŸ  ë¬¼í’ˆ ëª©ë¡</button>
    </li>
    <li class="nav-item">
        <button class="nav-link {% if active_tab == 'owner' %}active{% endif %}" 
                data-bs-toggle="tab" data-bs-target="#owner">ğŸ“¦ ë‚´ ë¬¼ê±´ ê´€ë¦¬</button>
    </li>
    <li class="nav-item">
        <button class="nav-link {% if active_tab == 'borrower' %}active{% endif %}" 
                data-bs-toggle="tab" data-bs-target="#borrower">ğŸ™‹â€â™‚ï¸ ë¹Œë¦° ë‚´ì—­</button>
    </li>
    <li class="nav-item">
        <button class="nav-link {% if active_tab == 'delivery' %}active{% endif %}" 
                data-bs-toggle="tab" data-bs-target="#delivery">ğŸšš ë°°ì†¡ ì•Œë°”</button>
    </li>
    {% if session['is_manager'] %}
    <li class="nav-item">
        <button class="nav-link text-danger fw-bold {% if active_tab == 'admin' %}active{% endif %}" 
                data-bs-toggle="tab" data-bs-target="#admin">ğŸ‘® ê´€ë¦¬ì í˜ì´ì§€</button>
    </li>
    {% endif %}
</ul>

<div class="tab-content">
    
    <div class="tab-pane fade {% if active_tab == 'home' %}show active{% endif %}" id="home">
        <div class="card mb-4 bg-light border-0">
            <div class="card-body p-3">
                <form method="GET" action="/" class="row g-2 align-items-center">
                    <div class="col-md-3">
                        <select name="category" class="form-select">
                            <option value="">ğŸ“‚ ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
                            <option value="ê³µêµ¬/ìˆ˜ë¦¬" {% if request.args.get('category') == 'ê³µêµ¬/ìˆ˜ë¦¬' %}selected{% endif %}>ğŸ”§ ê³µêµ¬/ìˆ˜ë¦¬</option>
                            <option value="ìº í•‘/ë ˆì €" {% if request.args.get('category') == 'ìº í•‘/ë ˆì €' %}selected{% endif %}>â›º ìº í•‘/ë ˆì €</option>
                            <option value="ìœ¡ì•„/ì¥ë‚œê°" {% if request.args.get('category') == 'ìœ¡ì•„/ì¥ë‚œê°' %}selected{% endif %}>ğŸ§¸ ìœ¡ì•„/ì¥ë‚œê°</option>
                            <option value="ì£¼ë°©/ìƒí™œ" {% if request.args.get('category') == 'ì£¼ë°©/ìƒí™œ' %}selected{% endif %}>ğŸ³ ì£¼ë°©/ìƒí™œ</option>
                            <option value="ì „ìê¸°ê¸°" {% if request.args.get('category') == 'ì „ìê¸°ê¸°' %}selected{% endif %}>ğŸ’» ì „ìê¸°ê¸°</option>
                            <option value="ë„ì„œ/ì·¨ë¯¸" {% if request.args.get('category') == 'ë„ì„œ/ì·¨ë¯¸' %}selected{% endif %}>ğŸ“š ë„ì„œ/ì·¨ë¯¸</option>
                            <option value="ê¸°íƒ€" {% if request.args.get('category') == 'ê¸°íƒ€' %}selected{% endif %}>ğŸ¸ ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select name="sort" class="form-select">
                            <option value="latest" {% if request.args.get('sort') == 'latest' %}selected{% endif %}>âœ¨ ìµœì‹  ë“±ë¡ìˆœ</option>
                            <option value="exp_date" {% if request.args.get('sort') == 'exp_date' %}selected{% endif %}>â° ë§Œë£Œ ì„ë°•ìˆœ</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="text" name="keyword" class="form-control" placeholder="ë¬¼í’ˆëª… ë˜ëŠ” ì„¤ëª… ê²€ìƒ‰" value="{{ request.args.get('keyword', '') }}">
                    </div>
                    <div class="col-md-2 d-grid gap-2 d-md-block">
                        <button type="submit" class="btn btn-primary">ê²€ìƒ‰</button>
                        <a href="/" class="btn btn-outline-secondary">ì´ˆê¸°í™”</a>
                    </div>
                </form>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>ëŒ€ì—¬ ê°€ëŠ¥í•œ ë¬¼í’ˆ</h4>
            {% if session['status'] == 'approved' %}
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registerModal">+ ë¬¼í’ˆ ë“±ë¡</button>
            {% else %}
                <span class="text-danger small">* ë§¤ë‹ˆì € ìŠ¹ì¸ í›„ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤. (í˜„ì¬ ìƒíƒœ: {{ session['status'] }})</span>
            {% endif %}
        </div>

        <div class="row">
            {% for item in items %}
            <div class="col-md-3 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <span class="badge bg-info text-dark mb-2">{{ item[2] }}</span>
                        <h5 class="card-title">{{ item[1] }}</h5>
                        <p class="card-text small text-muted">{{ item[5] }}</p>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <span class="text-primary fw-bold">{{ item[3] }} P</span>
                            <small>~ {{ item[4] }}</small>
                        </div>
                    </div>
                    <div class="card-footer bg-white border-top-0">
                        <a href="/rent/{{ item[0] }}" class="btn btn-outline-primary w-100 btn-sm">ëŒ€ì—¬ ì‹ ì²­</a>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="col-12 text-center py-5 text-muted">ë“±ë¡ëœ ë¬¼í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>
            {% endfor %}
        </div>
    </div>

    <div class="tab-pane fade {% if active_tab == 'owner' %}show active{% endif %}" id="owner">
        
        <h5>ğŸ“¥ ë“¤ì–´ì˜¨ ëŒ€ì—¬ ìš”ì²­</h5>
        <table class="table table-bordered">
            <thead><tr><th>ë¬¼í’ˆ</th><th>ì‹ ì²­ì</th><th>ê¸°ê°„</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
            <tbody>
                {% for req in incoming_requests %}
                <tr>
                    <td>{{ req[1] }}</td>
                    <td>{{ req[2] }}</td>
                    <td>{{ req[3] }} ~ {{ req[4] }}</td>
                    <td><span class="badge bg-warning text-dark">{{ req[5] }}</span></td>
                    <td>
                        <a href="/approve_rental/{{ req[0] }}" class="btn btn-sm btn-success" onclick="return confirm('ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ìŠ¹ì¸</a>
                        <a href="/reject_rental/{{ req[0] }}" class="btn btn-sm btn-danger" onclick="return confirm('ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ê±°ì ˆ</a>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="5" class="text-center text-muted">ë“¤ì–´ì˜¨ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                {% endfor %}
            </tbody>
        </table>
{% if my_disputes %}
        <div class="card border-danger mb-4">
            <div class="card-header bg-danger text-white fw-bold">
                âš–ï¸ ì§„í–‰ ì¤‘ì¸ ë¶„ìŸ
            </div>
            <div class="card-body p-0">
                <table class="table table-bordered mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>ë¬¼í’ˆëª…</th>
                            <th>ë¹Œë¦°ì‚¬ëŒ</th>
                            <th>ì§„í–‰ ìƒíƒœ</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for disp in my_disputes %}
                        <tr>
                            <td>{{ disp[1] }}</td>
                            <td>{{ disp[2] }}</td>
                            <td>
                                {% if disp[3] == 'open' %}
                                    <span class="badge bg-secondary">â³ ë§¤ë‹ˆì € ì‹¬ì‚¬ ì¤‘</span>
                                {% elif disp[3] == 'resolved' %}
                                    <span class="badge bg-success">âœ… íŒê²° ì™„ë£Œ</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if disp[3] == 'resolved' %}
                                    <button class="btn btn-sm btn-primary" 
                                        onclick='showResolution({{ disp[5] }}, {{ disp[4] | tojson }})'>
                                        ğŸ“œ íŒê²° ë³´ê¸° & ì¢…ë£Œ
                                    </button>
                                {% else %}
                                    <span class="text-muted small">ëŒ€ê¸° ì¤‘</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        <h5 class="mt-4">â†©ï¸ ë°˜ë‚© í™•ì¸ ë° ê²€ìˆ˜ (ë„ì°©í•œ ë¬¼í’ˆ)</h5>
        <table class="table table-bordered align-middle">
            <thead class="table-light"><tr><th>ë¬¼í’ˆ</th><th>ë¹Œë¦°ì‚¬ëŒ</th><th>ë°°ì†¡ìƒíƒœ</th><th>ê²€ìˆ˜ ë° í™•ì •</th></tr></thead>
            <tbody>
                {% for ret in arrived_returns %}
                <tr>
                    <td>{{ ret[1] }}</td>
                    <td>{{ ret[2] }}</td>
                    <td>
                        <span class="badge bg-primary">ë„ì°©í•¨ (Arrived)</span>
                        {% if ret[3] %}
                        <br><small class="text-muted cursor-pointer" onclick="showDriverInfo('{{ ret[3] }}', '{{ ret[4] }}', 'ë„ì°©')">ğŸšš {{ ret[3] }}</small>
                        {% endif %}
                    </td>
                    <td>
                        <a href="/confirm_return/{{ ret[0] }}" class="btn btn-sm btn-success w-100 mb-1" onclick="return confirm('ë¬¼í’ˆì— ì´ìƒì´ ì—†ìŠµë‹ˆê¹Œ? (ë°˜ë‚© í™•ì •)');">âœ… ë°˜ë‚© í™•ì • (ì´ìƒì—†ìŒ)</a>
                        
                        <button class="btn btn-sm btn-outline-danger w-100" onclick="openDisputeModal('{{ ret[0] }}', '{{ ret[1] }}')">
                            ğŸš¨ íŒŒì†/ë¶„ìŸ ì‹ ê³ 
                        </button>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="4" class="text-center text-muted py-3">í™•ì¸ ëŒ€ê¸° ì¤‘ì¸ ë°˜ë‚© ê±´ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="row mt-5">
            <div class="col-md-6">
                <h5 class="mt-4">ğŸ“¦ ë‚´ê°€ ë“±ë¡í•œ ë¬¼ê±´ í˜„í™©</h5>
        <ul class="list-group mb-4">
            {% for my in my_items %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <strong>{{ my[2] }}</strong> <span class="small text-muted">({{ my[3] }} P)</span>
                    <br>
                    {% if my[7] == 'available' %} <span class="badge bg-primary">ëŒ€ì—¬ ê°€ëŠ¥</span>
                    {% elif my[7] == 'rented' %} <span class="badge bg-success">ëŒ€ì—¬ ì¤‘</span>
                    {% elif my[7] == 'disputed' %} <span class="badge bg-danger">ë¶„ìŸ ì¤‘(ì ê¸ˆ)</span>
                    {% elif my[7] == 'withdrawn' %} <span class="badge bg-secondary">ì² íšŒë¨</span>
                    {% elif my[7] == 'expired' %} <span class="badge bg-dark">ë§Œë£Œë¨</span>
                    {% else %} <span class="badge bg-light text-dark border">{{ my[7] }}</span> {% endif %}
                </div>
                
                <div>
                    {% if my[7] == 'available' %}
                        <a href="/withdraw_item/{{ my[0] }}" class="btn btn-sm btn-outline-secondary" 
                           onclick="return confirm('ì •ë§ ì´ ë¬¼í’ˆì˜ ê³µìœ ë¥¼ ì¤‘ë‹¨(ì² íšŒ)í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                            ë“±ë¡ ì² íšŒ
                        </a>
                    {% endif %}
                </div>
            </li>
            {% endfor %}
        </ul>
            </div>
            <div class="col-md-6">
                <div class="card bg-light border-0 h-100">
                    <div class="card-body d-flex flex-column justify-content-center align-items-center">
                        <h5 class="card-title text-muted mb-3">ğŸ’° ì •ì‚° ë° ëŒ€ì—¬ ì´ë ¥</h5>
                        <p class="card-text text-center small text-muted">
                            ì§€ë‚œ ëŒ€ì—¬ ê¸°ë¡ê³¼ ìˆ˜ìµ ë‚´ì—­ì„ í™•ì¸í•˜ì„¸ìš”.<br>
                            ì™„ë£Œëœ ê±´ê³¼ ë¶„ìŸ ì²˜ë¦¬ëœ ê±´ì„ ì¡°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </p>
                        <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#historyModal">
                            ğŸ“œ ëŒ€ì—¬ ì´ë ¥ ì¡°íšŒí•˜ê¸°
                        </button>
                        <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#disputeHistoryModal">
                                âš–ï¸ ë¶„ìŸ ê¸°ë¡ ëª¨ì•„ë³´ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-pane fade {% if active_tab == 'borrower' %}show active{% endif %}" id="borrower">
        
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">ğŸ™‹â€â™‚ï¸ í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ëŒ€ì—¬</h5>
            <button class="btn btn-dark btn-sm" data-bs-toggle="modal" data-bs-target="#borrowerHistoryModal">
                ğŸ“œ ì§€ë‚œ ëŒ€ì—¬ ê¸°ë¡ (ì™„ë£Œ/ê±°ì ˆ)
            </button>
        </div>

        <div class="table-responsive mb-5">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>ë¬¼í’ˆëª…</th>
                        <th>ì†Œìœ ì</th>
                        <th>ê¸°ê°„</th>
                        <th>ìƒíƒœ</th>
                        <th>ë°°ì†¡/ë°˜ë‚©</th>
                        <th>ê¸°ì‚¬ì •ë³´</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rental in active_rentals %}
                    <tr>
                        <td><strong>{{ rental[1] }}</strong></td> 
                        <td>{{ rental[2] }}</td> 
                        <td>{{ rental[3] }} ~ {{ rental[4] }}</td>
                        <td>
                            {% if rental[5] == 'requested' %} <span class="badge bg-warning text-dark">ìŠ¹ì¸ ëŒ€ê¸°</span>
                            {% elif rental[5] == 'approved' %} <span class="badge bg-primary">ìŠ¹ì¸ë¨</span>
                            {% elif rental[5] == 'disputed' %} <span class="badge bg-danger">ë¶„ìŸ ì¤‘</span>
                            {% elif rental[5] == 'overdue' %} <span class="badge bg-danger">ì—°ì²´ë¨</span>
                            {% else %} <span class="badge bg-success">ëŒ€ì—¬ ì¤‘</span> {% endif %}
                        </td>
                        <td>
                            {{ rental[6] }}
                            {% if rental[5] in ['rented', 'overdue'] %}
                                <br>
                                {% if rental[6] in ['pending', 'completed'] or rental[6] is none %}
                                    <button class="btn btn-sm btn-outline-danger mt-1" onclick="openReturnModal('{{ rental[0] }}')">ë°˜ë‚©í•˜ê¸°</button>
                                {% else %}
                                    <span class="badge bg-secondary">ìš´ì†¡ì¤‘</span>
                                {% endif %}
                            {% endif %}
                        </td>
                        <td>
                            {% if rental[7] %} 
                                <button class="btn btn-sm btn-info text-white" 
                                        onclick="showDriverInfo('{{ rental[7] }}', '{{ rental[8] }}', '{{ rental[6] }}')">
                                    ë³´ê¸°
                                </button>
                            {% else %}
                                <span class="text-muted small">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="6" class="text-center text-muted py-4">í˜„ì¬ ë¹Œë¦¬ê³  ìˆëŠ” ë¬¼ê±´ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">
                    <span class="fw-bold">âš–ï¸ ë‚˜ì˜ ë¶„ìŸ ë‚´ì—­ (ëŒ€ì—¬ì)</span>
                    
                    <div class="d-flex gap-2">
                        <input type="text" id="disputeSearchInput" class="form-control form-control-sm" 
                               placeholder="ë¬¼í’ˆëª… ë˜ëŠ” ì†Œìœ ì ê²€ìƒ‰" 
                               onkeypress="if(event.keyCode==13) {updateDisputeList(); return false;}" 
                               style="max-width: 200px;">
                        
                        <select class="form-select form-select-sm w-auto text-dark" id="disputeSortSelect">
                            <option value="latest">ğŸ“… ë‚ ì§œ: ìµœì‹ ìˆœ (ê¸°ë³¸)</option>
                            <option value="open">â³ ìƒíƒœ: ì‹¬ì‚¬ ì¤‘ì¸ ê±´ ìš°ì„ </option>
                            <option value="resolved">âœ… ìƒíƒœ: íŒê²° ì™„ë£Œëœ ê±´ ìš°ì„ </option>
                        </select>

                        <button class="btn btn-light text-danger fw-bold btn-sm text-nowrap" type="button" onclick="updateDisputeList()">
                            ğŸ” ì¡°íšŒ
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card-body p-0">
                <table class="table table-hover align-middle mb-0" id="disputeTable">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 10%">ID</th>
                            <th style="width: 25%">ë¬¼í’ˆëª…</th>
                            <th style="width: 20%">ì†Œìœ ì(ì‹ ê³ ì)</th>
                            <th style="width: 20%">ì§„í–‰ ìƒíƒœ</th>
                            <th style="width: 15%">íŒê²° ë³´ê¸°</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in borrower_disputes %}
                        <tr data-id="{{ log[0] }}" 
                            data-item="{{ log[1] }}" 
                            data-owner="{{ log[2] }}" 
                            data-status="{{ log[5] }}">
                            
                            <td class="text-muted small">#{{ log[0] }}</td>
                            <td class="fw-bold">{{ log[1] }}</td>
                            <td>{{ log[2] }}</td>
                            <td>
                                {% if log[5] == 'open' %}
                                    <span class="badge bg-secondary">â³ ì‹¬ì‚¬ ì¤‘</span>
                                {% elif log[5] == 'resolved' %}
                                    <span class="badge bg-success">âœ… íŒê²° ì™„ë£Œ</span>
                                {% else %}
                                    <span class="badge bg-light text-dark">{{ log[5] }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-dark" 
                                        onclick="showDisputeDetail('{{ log[1] }}', '{{ log[3] }}', '{{ log[4] }}', '{{ log[6] }}')">
                                    ğŸ“œ ìƒì„¸
                                </button>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="5" class="text-center py-5 text-muted">ë¶„ìŸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="tab-pane fade {% if active_tab == 'delivery' %}show active{% endif %}" id="delivery">
        
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">ğŸšš ë°°ì†¡ íŒŒíŠ¸ë„ˆ ëŒ€ì‹œë³´ë“œ</h5>
            <button class="btn btn-success text-white btn-sm" data-bs-toggle="modal" data-bs-target="#deliveryHistoryModal">
                ğŸ’° ë°°ì†¡ ìˆ˜ìµ ë‚´ì—­ ë³´ê¸°
            </button>
        </div>

        <div class="card mb-4 border-success">
            <div class="card-header bg-success text-white fw-bold">ğŸ›µ ë‚´ ì§„í–‰ ì¤‘ì¸ ë°°ì†¡</div>
            <div class="card-body">
                {% if my_deliveries %}
                <table class="table align-middle">
                    <thead><tr><th>ë¬¼í’ˆ</th><th>ê²½ë¡œ (ì¶œë°œâ†’ë„ì°©)</th><th>ìˆ˜ìµ</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th><th>ì—°ë½ì²˜</th></tr></thead>
                    <tbody>
                        {% for job in my_deliveries %}
                        <tr>
                            <td>{{ job[1] }}</td>
                            <td>{{ job[3] }}ë™ {{ job[4] }}í˜¸ â {{ job[5] }}ë™ {{ job[6] }}í˜¸</td>
                            <td class="text-success fw-bold">+{{ job[2] }} P</td>
                            <td><span class="badge bg-info">{{ job[7] }}</span></td>
                            <td>
                                {% if job[7] == 'accepted' %}
                                    <a href="/pickup_delivery/{{ job[0] }}" class="btn btn-sm btn-warning">í”½ì—…</a>
                                    <a href="/cancel_delivery/{{ job[0] }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('ì •ë§ ë°°ì†¡ì„ í¬ê¸°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì·¨ì†Œ</a>
                                {% elif job[7] == 'picked_up' %}
                                    <a href="/complete_delivery/{{ job[0] }}" class="btn btn-sm btn-primary">ë„ì°©(ì™„ë£Œ)</a>
                                {% elif job[7] == 'arrived' %}
                                    <span class="text-muted small">í™•ì¸ ëŒ€ê¸°ì¤‘</span>
                                {% else %} 
                                    ì™„ë£Œë¨ 
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-dark" 
                                        onclick="showContactInfo('{{ job[9] }}', '{{ job[10] }}')">
                                    ğŸ“ ì—°ë½ì²˜
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %} <p class="text-muted">ì§„í–‰ ì¤‘ì¸ ë°°ì†¡ì´ ì—†ìŠµë‹ˆë‹¤.</p> {% endif %}
            </div>
        </div>

        <h5 class="mb-3">ğŸš€ ë°°ì†¡ ì½œ ëŒ€ê¸° ëª©ë¡</h5>
        {% if delivery_market %}
        <div class="row">
            {% for call in delivery_market %}
            <div class="col-md-4 mb-3">
                <div class="card h-100 border-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <h5 class="card-title">{{ call[1] }}</h5>
                            <span class="text-success fw-bold">{{ call[2] }} P</span>
                        </div>
                        <hr>
                        <p class="card-text mb-1">ğŸ›« <strong>ì¶œë°œ:</strong> {{ call[3] }}ë™ {{ call[4] }}í˜¸</p>
                        <p class="card-text">ğŸ›¬ <strong>ë„ì°©:</strong> {{ call[5] }}ë™ {{ call[6] }}í˜¸</p>
                        <a href="/accept_delivery/{{ call[0] }}" class="btn btn-outline-success w-100 mt-2">ìˆ˜ë½í•˜ê¸°</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %} <div class="alert alert-secondary text-center">ìš”ì²­ëœ ë°°ì†¡ì´ ì—†ìŠµë‹ˆë‹¤.</div> {% endif %}
    </div>

    <div class="tab-pane fade {% if active_tab == 'admin' %}show active{% endif %}" id="admin">
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card h-100 border-primary">
                    <div class="card-header bg-primary text-white fw-bold">ğŸ“ ì‹ ê·œ ê°€ì… ìš”ì²­</div>
                    <ul class="list-group list-group-flush">
                        {% for user in pending_residents %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div><strong>{{ user[2] }}</strong> ({{ user[4] }}ë™ {{ user[5] }}í˜¸)<br><small class="text-muted">ID: {{ user[1] }}</small></div>
                            <div>
                                <a href="/approve_resident/{{ user[0] }}" class="btn btn-sm btn-success">ìŠ¹ì¸</a>
                                <a href="/reject_resident/{{ user[0] }}" class="btn btn-sm btn-danger">ê±°ì ˆ</a>
                            </div>
                        </li>
                        {% else %} <li class="list-group-item text-center text-muted">ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ ì—†ìŒ</li> {% endfor %}
                    </ul>
                </div>
            </div>
            <div class="col-md-7">
                <div class="card h-100 border-danger">
                    <div class="card-header bg-danger text-white fw-bold">
                        âš–ï¸ ë¶„ìŸ ì‹ ê³  ì ‘ìˆ˜ í˜„í™©
                    </div>
                    <div class="card-body p-0">
                        {% if open_disputes %}
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 30%;">ë¬¼í’ˆ/ì‚¬ìœ </th>
                                        <th style="width: 25%;">ì‹ ê³ ì (ID)</th>
                                        <th style="width: 25%;">í”¼ì‹ ê³ ì (ID)</th>
                                        <th style="width: 20%;">ê´€ë¦¬</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for d in open_disputes %}
                                    <tr>
                                        <td>
                                            <strong>{{ d[5] }}</strong><br>
                                            <span class="text-danger small">{{ d[2] }}</span>
                                        </td>
                                        
                                        <td>
                                            <span class="badge bg-light text-dark border">{{ d[3] }}</span>
                                        </td>
                                        
                                        <td>
                                            <span class="badge bg-light text-dark border">{{ d[4] }}</span>
                                        </td>
                                        
                                        <td>
                                            <button class="btn btn-sm btn-danger w-100" 
                                                    onclick="openAdjudicateModal('{{ d[0] }}', '{{ d[3] }}', '{{ d[4] }}')">
                                                íŒê²°í•˜ê¸°
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted text-center py-5">í˜„ì¬ ì ‘ìˆ˜ëœ ë¶„ìŸì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <hr>
        
        <div class="card border-secondary">
             <div class="card-header bg-secondary text-white fw-bold">ğŸ‘¥ ì „ì²´ ì£¼ë¯¼ ê´€ë¦¬ (ì²˜ë¦¬ ì´ë ¥)</div>
             <div class="card-body">
                 <form method="GET" action="/" class="row g-2 mb-3">
                     <input type="hidden" name="tab" value="admin">
                     <div class="col-auto">
                         <select name="f" class="form-select form-select-sm">
                             <option value="all" {% if filter_status == 'all' %}selected{% endif %}>ì „ì²´</option>
                             <option value="approved" {% if filter_status == 'approved' %}selected{% endif %}>âœ… ìŠ¹ì¸ë¨</option>
                             <option value="rejected" {% if filter_status == 'rejected' %}selected{% endif %}>ğŸš« ê±°ì ˆë¨</option>
                         </select>
                     </div>
                     <div class="col-auto"><input type="text" name="q" class="form-control form-control-sm" placeholder="ì´ë¦„/ID" value="{{ search_query }}"></div>
                     <div class="col-auto"><button type="submit" class="btn btn-sm btn-dark">ê²€ìƒ‰</button></div>
                 </form>
                 <table class="table table-hover align-middle">
                     <thead class="table-light"><tr><th>ID</th><th>ì´ë¦„</th><th>ì—°ë½ì²˜</th><th>ìƒíƒœ</th><th>ì•¡ì…˜</th></tr></thead>
                     <tbody>
                         {% for user in history_residents %}
                         <tr>
                             <td>{{ user[1] }}</td>
                             <td>{{ user[2] }} ({{ user[4] }}ë™ {{ user[5] }}í˜¸)</td>
                             <td>{{ user[3] }}</td>
                             <td>
                                 {% if user[6] == 'approved' %} <span class="badge bg-success">ìŠ¹ì¸</span>
                                 {% else %} <span class="badge bg-dark">ê±°ì ˆ</span> {% endif %}
                             </td>
                             <td>
                                 {% if user[6] == 'approved' %}
                                     <a href="/reject_resident/{{ user[0] }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('ì •ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì •ì§€</a>
                                 {% else %}
                                     <a href="/approve_resident/{{ user[0] }}" class="btn btn-sm btn-outline-success" onclick="return confirm('ì¬ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì¬ìŠ¹ì¸</a>
                                 {% endif %}
                             </td>
                             <td>
                                {% if user[7] %} <a href="/toggle_delivery_ban/{{ user[0] }}" class="btn btn-sm btn-warning">âœ… ë°°ì†¡ ë³µêµ¬</a>
                                {% else %}
                                    <a href="/toggle_delivery_ban/{{ user[0] }}" class="btn btn-sm btn-dark">ğŸš« ë°°ì†¡ ì •ì§€</a>
                                {% endif %}
                            </td>
                         </tr>
                         {% else %} <tr><td colspan="5" class="text-center text-muted">ê²°ê³¼ ì—†ìŒ</td></tr> {% endfor %}
                     </tbody>
                 </table>
             </div>
        </div>
    </div>
</div>

<div class="modal fade" id="registerModal" tabindex="-1">
    <div class="modal-dialog">
        <form action="/register_item" method="POST">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ“¦ ë‚´ ë¬¼ê±´ ë“±ë¡í•˜ê¸°</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label fw-bold">ë¬¼í’ˆëª…</label>
                    <input type="text" name="name" class="form-control mb-3" placeholder="ì˜ˆ: ì „ë™ë“œë¦´" required>
                    
                    <label class="form-label fw-bold">ì¹´í…Œê³ ë¦¬</label>
                    <select name="category" class="form-select mb-3">
                        <option value="ê³µêµ¬/ìˆ˜ë¦¬">ğŸ”§ ê³µêµ¬/ìˆ˜ë¦¬</option>
                        <option value="ìº í•‘/ë ˆì €">â›º ìº í•‘/ë ˆì €</option>
                        <option value="ìœ¡ì•„/ì¥ë‚œê°">ğŸ§¸ ìœ¡ì•„/ì¥ë‚œê°</option>
                        <option value="ì£¼ë°©/ìƒí™œ">ğŸ³ ì£¼ë°©/ìƒí™œ</option>
                        <option value="ì „ìê¸°ê¸°">ğŸ’» ì „ìê¸°ê¸°</option>
                        <option value="ë„ì„œ/ì·¨ë¯¸">ğŸ“š ë„ì„œ/ì·¨ë¯¸</option>
                        <option value="ê¸°íƒ€">ğŸ¸ ê¸°íƒ€</option>
                    </select>
                    
                    <label class="form-label fw-bold">ìƒì„¸ ì„¤ëª…</label>
                    <textarea name="description" class="form-control mb-3" rows="3" placeholder="ìƒì„¸ ì„¤ëª…"></textarea>
                    
                    <label class="form-label fw-bold">1ì¼ ëŒ€ì—¬ë£Œ (í¬ì¸íŠ¸)</label>
                    <div class="input-group mb-3">
                        <input type="number" name="rent_fee" class="form-control" placeholder="0" min="0" required>
                        <span class="input-group-text">P / 1ì¼</span>
                    </div>

                    <label class="form-label fw-bold">ê³µìœ  ë§ˆê°ì¼</label>
                    <input type="date" name="expiration_date" class="form-control" min="{{ date_today }}" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ë“±ë¡í•˜ê¸°</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="returnModal" tabindex="-1">
    <div class="modal-dialog">
        <form id="returnForm" method="POST">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">â†©ï¸ ë¬¼í’ˆ ë°˜ë‚©í•˜ê¸°</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>ë°˜ë‚© ë°©ì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                    <div class="mb-3">
                        <label class="form-label fw-bold">ìš´ì†¡ ë°©ì‹</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="delivery_option" id="return_pickup" value="pickup" checked>
                            <label class="btn btn-outline-secondary" for="return_pickup">ğŸ¤ ì§ì ‘ ë°˜ë‚© (ë¬´ë£Œ)</label>

                            <input type="radio" class="btn-check" name="delivery_option" id="return_delivery" value="delivery">
                            <label class="btn btn-outline-secondary" for="return_delivery">ğŸšš ë°°ì†¡ ë°˜ë‚© (+500 P)</label>
                        </div>
                    </div>
                    <div class="alert alert-info small">
                        ë°°ì†¡ ë°˜ë‚© ì„ íƒ ì‹œ, ë°°ì†¡ ê¸°ì‚¬ê°€ ë§¤ì¹­ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì•¼ í•©ë‹ˆë‹¤.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ë°˜ë‚© ì‹ ì²­</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="infoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">ğŸ“‹ ìƒì„¸ ì •ë³´</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="modalContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ê¸°ì‚¬ ì •ë³´ ëª¨ë‹¬ ë‚´ìš© ì±„ìš°ê¸°
    function showDriverInfo(name, phone, status) {
        const content = `
            <h6 class="fw-bold">ğŸšš ë°°ì†¡ ê¸°ì‚¬ ì •ë³´</h6>
            <p>ì´ë¦„: <strong>${name}</strong></p>
            <p>ì—°ë½ì²˜: <a href="tel:${phone}" class="fw-bold text-decoration-none">${phone}</a></p>
            <hr>
            <p>í˜„ì¬ ìƒíƒœ: <span class="badge bg-primary">${status}</span></p>
        `;
        document.getElementById('modalContent').innerHTML = content;
        new bootstrap.Modal(document.getElementById('infoModal')).show();
    }

    // ì—°ë½ì²˜ ì •ë³´ ëª¨ë‹¬ ë‚´ìš© ì±„ìš°ê¸°
    function showContactInfo(startPhone, endPhone) {
        const content = `
            <h6 class="fw-bold">ğŸ“ ì—°ë½ì²˜ ì •ë³´</h6>
            <div class="alert alert-light border">
                <p class="mb-1">ğŸ›« <strong>ì¶œë°œì§€ ì£¼ë¯¼:</strong></p>
                <a href="tel:${startPhone}" class="fs-5 text-decoration-none">${startPhone}</a>
            </div>
            <div class="alert alert-light border">
                <p class="mb-1">ğŸ›¬ <strong>ë„ì°©ì§€ ì£¼ë¯¼:</strong></p>
                <a href="tel:${endPhone}" class="fs-5 text-decoration-none">${endPhone}</a>
            </div>
        `;
        document.getElementById('modalContent').innerHTML = content;
        new bootstrap.Modal(document.getElementById('infoModal')).show();
    }

    // ë°˜ë‚© ëª¨ë‹¬ ì—´ê¸°
    function openReturnModal(rentalId) {
        document.getElementById('returnForm').action = "/request_return/" + rentalId;
        var myModal = new bootstrap.Modal(document.getElementById('returnModal'));
        myModal.show();
    }
</script>
<div class="modal fade" id="disputeModal" tabindex="-1">
    <div class="modal-dialog">
        <form id="disputeForm" method="POST">
            <div class="modal-content border-danger">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">ğŸš¨ ë¶„ìŸ(íŒŒì†) ì‹ ê³ </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="fw-bold text-danger">ì£¼ì˜: ì‹ ê³  ì‹œ í•´ë‹¹ ë¬¼í’ˆì€ 'ì ê¸ˆ' ì²˜ë¦¬ë˜ì–´ ëŒ€ì—¬ê°€ ì¤‘ë‹¨ë©ë‹ˆë‹¤.</p>
                    <p>ë¬¼í’ˆëª…: <strong id="disputeItemName"></strong></p>
                    
                    <label class="form-label">ì‹ ê³  ì‚¬ìœ  ë° ìƒì„¸ ë‚´ìš©</label>
                    <textarea name="reason" class="form-control" rows="4" placeholder="ì˜ˆ: ë°˜ë‚©ëœ ì˜ìì˜ ë‹¤ë¦¬ê°€ ë¶€ëŸ¬ì ¸ ìˆìŠµë‹ˆë‹¤. ì‚¬ì§„ ì²¨ë¶€ ë“±..." required></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-danger">ì‹ ê³  ì ‘ìˆ˜</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">ğŸ“œ ë‚´ ë¬¼ê±´ ëŒ€ì—¬ ì´ë ¥</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-2 mb-3">
                    <div class="col-md-8">
                        <input type="text" id="historySearch" class="form-control" placeholder="ë¬¼í’ˆëª… ë˜ëŠ” ë¹Œë¦° ì‚¬ëŒ ì´ë¦„ ê²€ìƒ‰..." onkeyup="filterHistory()">
                    </div>
                    <div class="col-md-4">
                        <select id="historySort" class="form-select" onchange="sortHistory()">
                            <option value="latest">â–¼ ìµœì‹ ìˆœ (ê¸°ë³¸)</option>
                            <option value="oldest">â–² ì˜¤ë˜ëœìˆœ</option>
                            <option value="income">ğŸ’° ìˆ˜ìµ ë†’ì€ìˆœ</option>
                        </select>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover table-sm" id="historyTable">
                        <thead class="table-light">
                            <tr>
                                <th>ë‚ ì§œ</th>
                                <th>ë¬¼í’ˆëª…</th>
                                <th>ë¹Œë¦° ì‚¬ëŒ</th>
                                <th>ìƒíƒœ</th>
                                <th class="text-end">ìˆ˜ìµ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in owner_history %}
                            <tr>
                                <td class="small">{{ log[3] }}<br>~ {{ log[4] }}</td>
                                <td><strong>{{ log[1] }}</strong></td>
                                <td>{{ log[2] }}</td>
                                <td>
                                    {% if log[5] == 'completed' or log[5] == 'returned' %}
                                        <span class="badge bg-success">ì™„ë£Œ</span>
                                    {% elif log[5] == 'disputed' %}
                                        <span class="badge bg-danger">ë¶„ìŸ</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ log[5] }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-end fw-bold text-primary" data-income="{{ log[6] }}">
                                    +{{ log[6] }} P
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="5" class="text-center py-4 text-muted">ì•„ì§ ëŒ€ì—¬ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ë¶„ìŸ ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜
    function openDisputeModal(rentalId, itemName) {
        document.getElementById('disputeForm').action = "/report_dispute/" + rentalId;
        document.getElementById('disputeItemName').innerText = itemName;
        new bootstrap.Modal(document.getElementById('disputeModal')).show();
    }

    // ì´ë ¥ ê²€ìƒ‰ í•„í„°ë§ (JS)
    function filterHistory() {
        const input = document.getElementById('historySearch').value.toUpperCase();
        const table = document.getElementById('historyTable');
        const tr = table.getElementsByTagName('tr');

        for (let i = 1; i < tr.length; i++) { // í—¤ë” ì œì™¸
            const tdName = tr[i].getElementsByTagName('td')[1]; // ë¬¼í’ˆëª…
            const tdUser = tr[i].getElementsByTagName('td')[2]; // ë¹Œë¦°ì‚¬ëŒ
            if (tdName && tdUser) {
                const txtValue = (tdName.textContent || tdName.innerText) + " " + (tdUser.textContent || tdUser.innerText);
                if (txtValue.toUpperCase().indexOf(input) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }

    // ì´ë ¥ ì •ë ¬ (JS)
    function sortHistory() {
        const table = document.getElementById("historyTable");
        const tbody = table.querySelector("tbody");
        const rows = Array.from(tbody.querySelectorAll("tr"));
        const option = document.getElementById("historySort").value;

        if (rows.length <= 1) return; // ë°ì´í„° ì—†ìœ¼ë©´ íŒ¨ìŠ¤

        rows.sort((a, b) => {
            // ë‚ ì§œ ë¹„êµ (1ë²ˆì§¸ ì»¬ëŸ¼)
            const dateA = a.cells[0].innerText.split('~')[0].trim();
            const dateB = b.cells[0].innerText.split('~')[0].trim();
            
            // ìˆ˜ìµ ë¹„êµ (ë§ˆì§€ë§‰ ì»¬ëŸ¼ data-income ì†ì„± í™œìš©)
            const incomeA = parseInt(a.cells[4].getAttribute('data-income') || 0);
            const incomeB = parseInt(b.cells[4].getAttribute('data-income') || 0);

            if (option === 'latest') return dateB.localeCompare(dateA); // ë‚´ë¦¼ì°¨ìˆœ
            if (option === 'oldest') return dateA.localeCompare(dateB); // ì˜¤ë¦„ì°¨ìˆœ
            if (option === 'income') return incomeB - incomeA; // ìˆ˜ìµ ë†’ì€ìˆœ
        });

        rows.forEach(row => tbody.appendChild(row));
    }
</script>
<div class="modal fade" id="borrowerHistoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title">ğŸ“œ ì§€ë‚œ ëŒ€ì—¬ ê¸°ë¡ (ì™„ë£Œ/ê±°ì ˆ)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" id="borrowerHistorySearch" class="form-control" placeholder="ë¬¼í’ˆëª… ë˜ëŠ” ì†Œìœ ì ì´ë¦„ ê²€ìƒ‰..." onkeyup="filterBorrowerHistory()">
                </div>

                <table class="table table-hover table-sm" id="borrowerHistoryTable">
                    <thead class="table-light">
                        <tr>
                            <th>ê¸°ê°„</th>
                            <th>ë¬¼í’ˆëª…</th>
                            <th>ì†Œìœ ì</th>
                            <th>ìµœì¢… ìƒíƒœ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in borrower_history %}
                        <tr>
                            <td class="small">{{ log[3] }}<br>~ {{ log[4] }}</td>
                            <td><strong>{{ log[1] }}</strong></td>
                            <td>{{ log[2] }}</td>
                            <td>
                                {% if log[5] == 'returned' %} <span class="badge bg-secondary">ë°˜ë‚© ì™„ë£Œ</span>
                                {% elif log[5] == 'rejected' %} <span class="badge bg-danger">ê±°ì ˆë¨</span>
                                {% else %} {{ log[5] }} {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="4" class="text-center py-4 text-muted">ì§€ë‚œ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ëŒ€ì—¬ì ì´ë ¥ ê²€ìƒ‰ í•„í„° (JS)
    function filterBorrowerHistory() {
        const input = document.getElementById('borrowerHistorySearch').value.toUpperCase();
        const table = document.getElementById('borrowerHistoryTable');
        const tr = table.getElementsByTagName('tr');

        for (let i = 1; i < tr.length; i++) {
            const tdName = tr[i].getElementsByTagName('td')[1]; // ë¬¼í’ˆëª…
            const tdOwner = tr[i].getElementsByTagName('td')[2]; // ì†Œìœ ì
            if (tdName && tdOwner) {
                const txtValue = (tdName.textContent || tdName.innerText) + " " + (tdOwner.textContent || tdOwner.innerText);
                if (txtValue.toUpperCase().indexOf(input) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }
</script>
<div class="modal fade" id="deliveryHistoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">ğŸ’° ë°°ì†¡ ìˆ˜ìµ ë‚´ì—­ (ì •ì‚° ì™„ë£Œ)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-light border text-center mb-3">
                    <span class="text-muted">ì´ ì™„ë£Œ ê±´ìˆ˜:</span> <strong>{{ delivery_history|length }}ê±´</strong>
                    <span class="mx-2">|</span>
                    <span class="text-muted">ì´ ëˆ„ì  ìˆ˜ìµ:</span> 
                    <strong class="text-success fs-5">
                        {% set total = namespace(value=0) %}
                        {% for log in delivery_history %}
                            {% set total.value = total.value + log[2] %}
                        {% endfor %}
                        +{{ total.value }} P
                    </strong>
                </div>

                <table class="table table-hover table-sm align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>êµ¬ë¶„</th>
                            <th>ë¬¼í’ˆëª…</th>
                            <th>ë°°ì†¡ ê²½ë¡œ</th>
                            <th class="text-end">ìˆ˜ìµ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in delivery_history %}
                        <tr>
                            <td>
                                {% if log[7] == 'returned' %}
                                    <span class="badge bg-secondary">ë°˜ë‚© ë°°ì†¡</span>
                                {% else %}
                                    <span class="badge bg-primary">ëŒ€ì—¬ ë°°ì†¡</span>
                                {% endif %}
                            </td>
                            <td><strong>{{ log[1] }}</strong></td>
                            <td class="small">
                                {{ log[3] }}ë™ {{ log[4] }}í˜¸ â {{ log[5] }}ë™ {{ log[6] }}í˜¸
                            </td>
                            <td class="text-end fw-bold text-success">+{{ log[2] }} P</td>
                        </tr>
                        {% else %}
                        <tr><td colspan="4" class="text-center py-4 text-muted">ì™„ë£Œëœ ë°°ì†¡ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="resolutionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-success">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">ğŸ“œ ë§¤ë‹ˆì € íŒê²° ê²°ê³¼</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6 class="fw-bold">ë§¤ë‹ˆì € ì½”ë©˜íŠ¸:</h6>
                <div class="alert alert-light border p-3 mb-3" id="resolutionText" style="white-space: pre-line;">
                    </div>
                <p class="small text-muted">
                    * ìœ„ íŒê²°ì— ë”°ë¼ í¬ì¸íŠ¸ ì •ì‚°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.<br>
                    * [ìµœì¢… í™•ì¸]ì„ ëˆ„ë¥´ë©´ ë¬¼í’ˆ ì ê¸ˆì´ í•´ì œë˜ê³  ëŒ€ì—¬ ê°€ëŠ¥ ìƒíƒœë¡œ ë³€ê²½ë©ë‹ˆë‹¤.
                </p>
            </div>
            <div class="modal-footer">
                <form id="closeDisputeForm" method="GET">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                    <button type="submit" class="btn btn-success">ìµœì¢… í™•ì¸ (ìƒí™© ì¢…ë£Œ)</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // íŒê²° ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜
    function showResolution(disputeId, resolutionText) {
        document.getElementById('resolutionText').innerText = resolutionText;
        // í™•ì¸ ë²„íŠ¼ ëˆ„ë¥´ë©´ /close_dispute/ID ë¡œ ì´ë™
        document.getElementById('closeDisputeForm').action = "/close_dispute/" + disputeId;
        new bootstrap.Modal(document.getElementById('resolutionModal')).show();
    }
</script>
<div class="modal fade" id="disputeHistoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">âš–ï¸ ë‚´ ë¬¼ê±´ ë¶„ìŸ ê¸°ë¡(ì†Œìœ ì)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>ë¬¼í’ˆëª…</th>
                            <th>ë¹Œë¦°ì‚¬ëŒ</th>
                            <th>ìƒíƒœ</th>
                            <th>ìƒì„¸ë³´ê¸°</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in dispute_history %}
                        <tr>
                            <td><strong>{{ log[1] }}</strong></td>
                            <td>{{ log[2] }}</td>
                            <td>
                                {% if log[5] == 'open' %}
                                    <span class="badge bg-secondary">ì§„í–‰ ì¤‘</span>
                                {% elif log[5] == 'resolved' %}
                                    <span class="badge bg-success">í•´ê²°ë¨</span>
                                {% else %}
                                    {{ log[5] }}
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-dark" 
                                        onclick="showDisputeDetail('{{ log[1] }}', '{{ log[3] }}', '{{ log[4] }}', '{{ log[6] }}')">
                                    ìƒì„¸
                                </button>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="4" class="text-center py-4 text-muted">ë¶„ìŸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="disputeDetailModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ğŸ“„ ë¶„ìŸ ìƒì„¸ ë‚´ìš©</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6 class="fw-bold">ğŸ“¦ ë¬¼í’ˆëª…</h6>
                <p id="dispDetailItem"></p>
                <hr>
                <h6 class="fw-bold text-danger">ğŸš¨ ì‹ ê³  ì‚¬ìœ </h6>
                <div class="alert alert-light border" id="dispDetailReason" style="white-space: pre-line;"></div>
                
                <h6 class="fw-bold text-success">âš–ï¸ íŒê²° ë‚´ìš©</h6>
                <div class="alert alert-success border" id="dispDetailResolution" style="white-space: pre-line;"></div>
                
                <div id="dispCompSection" style="display:none;">
                    <h6 class="fw-bold">ğŸ’° ë°°ìƒê¸ˆ</h6>
                    <p class="text-danger fw-bold" id="dispDetailComp"></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function showDisputeDetail(item, reason, resolution, compensation) {
        document.getElementById('dispDetailItem').innerText = item;
        document.getElementById('dispDetailReason').innerText = reason;
        
        const resBox = document.getElementById('dispDetailResolution');
        if (resolution && resolution !== 'None') {
            resBox.innerText = resolution;
            resBox.classList.remove('d-none');
        } else {
            resBox.innerText = "(ì•„ì§ íŒê²°ì´ ë‚´ë ¤ì§€ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤)";
            resBox.classList.add('text-muted');
        }

        const compSec = document.getElementById('dispCompSection');
        if (compensation && compensation !== '0' && compensation !== 'None') {
            compSec.style.display = 'block';
            document.getElementById('dispDetailComp').innerText = compensation + " P";
        } else {
            compSec.style.display = 'none';
        }

        // íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ ìœ„ì— ìƒì„¸ ëª¨ë‹¬ì„ ë„ìš°ê¸° ìœ„í•´ z-index ì¡°ì • ë˜ëŠ” ë‹«ê³  ì—´ê¸°
        // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ ìƒˆ ëª¨ë‹¬ì„ ë„ì›ë‹ˆë‹¤.
        new bootstrap.Modal(document.getElementById('disputeDetailModal')).show();
    }
</script>
<div class="modal fade" id="adjudicateModal" tabindex="-1">
    <div class="modal-dialog">
        <form id="adjudicateForm" method="POST">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">âš–ï¸ ë¶„ìŸ íŒê²° (Adjudication)</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning small">
                        <strong>ë‹¹ì‚¬ì:</strong> <span id="adjOwner"></span>(ì†Œìœ ì) vs <span id="adjBorrower"></span>(ëŒ€ì—¬ì)<br>
                        * íŒê²° í™•ì • ì‹œ í¬ì¸íŠ¸ê°€ ì¦‰ì‹œ ì´ì²´ë˜ë©° ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">íŒê²° ë‚´ìš© (Resolution)</label>
                        <textarea name="resolution" class="form-control" rows="3" placeholder="íŒê²° ì´ìœ ì™€ ê²°ê³¼ë¥¼ ìƒì„¸íˆ ì ì–´ì£¼ì„¸ìš”." required></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">ë°°ìƒê¸ˆ (Compensation)</label>
                        <div class="input-group">
                            <input type="number" name="amount" class="form-control" value="0" min="0" required>
                            <span class="input-group-text">P</span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">ì§€ë¶ˆ ë°©í–¥</label>
                        <div class="list-group">
                            <label class="list-group-item">
                                <input class="form-check-input me-1" type="radio" name="decision" value="borrower_to_owner" checked>
                                ëŒ€ì—¬ì â” ì†Œìœ ì (íŒŒì† ë°°ìƒ ë“±)
                            </label>
                            <label class="list-group-item">
                                <input class="form-check-input me-1" type="radio" name="decision" value="owner_to_borrower">
                                ì†Œìœ ì â” ëŒ€ì—¬ì (ë¶€ë‹¹ ìš”ê¸ˆ ë°˜í™˜)
                            </label>
                            <label class="list-group-item">
                                <input class="form-check-input me-1" type="radio" name="decision" value="none">
                                ë°°ìƒ ì—†ìŒ (í™”í•´/ê¸°ê°)
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-danger">ìµœì¢… íŒê²°í•˜ê¸°</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    function openAdjudicateModal(disputeId, ownerName, borrowerName) {
        document.getElementById('adjudicateForm').action = "/adjudicate_dispute/" + disputeId;
        document.getElementById('adjOwner').innerText = ownerName;
        document.getElementById('adjBorrower').innerText = borrowerName;
        new bootstrap.Modal(document.getElementById('adjudicateModal')).show();
    }
</script>
<div class="modal fade" id="borrowerDisputeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">âš–ï¸ ë‚˜ì˜ ë¶„ìŸ ë‚´ì—­ (ëŒ€ì—¬ì)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-light border small text-muted text-center mb-3">
                    * ì´ê³³ì—ì„œëŠ” ì†Œìœ ìê°€ ì‹ ê³ í•œ ë¶„ìŸ ë‚´ì—­ê³¼ ë§¤ë‹ˆì €ì˜ íŒê²° ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                    * íŒê²°ì— ëŒ€í•œ ì´ì˜ ì œê¸°ëŠ” ë§¤ë‹ˆì €ì—ê²Œ ì§ì ‘ ë¬¸ì˜í•´ì£¼ì„¸ìš”.
                </div>

                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>ë¬¼í’ˆëª…</th>
                            <th>ì†Œìœ ì(ì‹ ê³ ì)</th>
                            <th>ìƒíƒœ</th>
                            <th>íŒê²° ë³´ê¸°</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in borrower_disputes %}
                        <tr>
                            <td><strong>{{ log[1] }}</strong></td>
                            <td>{{ log[2] }}</td>
                            <td>
                                {% if log[5] == 'open' %}
                                    <span class="badge bg-secondary">ì‹¬ì‚¬ ì¤‘</span>
                                {% elif log[5] == 'resolved' %}
                                    <span class="badge bg-success">íŒê²° ì™„ë£Œ</span>
                                {% else %}
                                    {{ log[5] }}
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-dark" 
                                        onclick="showDisputeDetail('{{ log[1] }}', '{{ log[3] }}', '{{ log[4] }}', '{{ log[6] }}')">
                                    ğŸ“œ ìƒì„¸
                                </button>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="4" class="text-center py-4 text-muted">ë¶„ìŸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>
<script>
    // [í†µí•© í•¨ìˆ˜] ê²€ìƒ‰ê³¼ ì •ë ¬ì„ í•œ ë²ˆì— ì‹¤í–‰
    function updateDisputeList() {
        const table = document.getElementById("disputeTable");
        const tbody = table.querySelector("tbody");
        const rows = Array.from(tbody.querySelectorAll("tr"));
        
        // ë°ì´í„° ì—†ìœ¼ë©´ ì¤‘ë‹¨
        if (rows.length <= 1 && !rows[0].hasAttribute('data-id')) return;

        // 1. ê²€ìƒ‰ì–´ í•„í„°ë§ (Filtering)
        const searchInput = document.getElementById('disputeSearchInput').value.toUpperCase();
        
        rows.forEach(row => {
            const item = row.getAttribute('data-item');
            const owner = row.getAttribute('data-owner');
            
            if (item && owner) {
                if (item.toUpperCase().indexOf(searchInput) > -1 || owner.toUpperCase().indexOf(searchInput) > -1) {
                    row.style.display = ""; // ë³´ì„
                } else {
                    row.style.display = "none"; // ìˆ¨ê¹€
                }
            }
        });

        // 2. ì •ë ¬ ì‹¤í–‰ (Sorting)
        const sortOption = document.getElementById("disputeSortSelect").value;

        rows.sort((a, b) => {
            const idA = parseInt(a.getAttribute('data-id'));
            const idB = parseInt(b.getAttribute('data-id'));
            const statusA = a.getAttribute('data-status');
            const statusB = b.getAttribute('data-status');

            if (sortOption === 'latest') {
                return idB - idA; // ìµœì‹ ìˆœ
            } 
            else if (sortOption === 'open') {
                // ì‹¬ì‚¬ì¤‘('open') ìš°ì„ 
                if (statusA === 'open' && statusB !== 'open') return -1;
                if (statusA !== 'open' && statusB === 'open') return 1;
                return idB - idA;
            } 
            else if (sortOption === 'resolved') {
                // ì™„ë£Œë¨('resolved') ìš°ì„ 
                if (statusA === 'resolved' && statusB !== 'resolved') return -1;
                if (statusA !== 'resolved' && statusB === 'resolved') return 1;
                return idB - idA;
            }
        });

        // ì •ë ¬ëœ ìˆœì„œëŒ€ë¡œ ë‹¤ì‹œ ë°°ì¹˜
        rows.forEach(row => tbody.appendChild(row));
    }
</script>
{% endblock %}
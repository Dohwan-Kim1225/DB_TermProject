{% extends 'base.html' %}

{% block content %}
<ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
    <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#home">ğŸ  ë¬¼í’ˆ ëª©ë¡</button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#owner">ğŸ“¦ ë‚´ ë¬¼ê±´ ê´€ë¦¬</button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#borrower">ğŸ™‹â€â™‚ï¸ ë¹Œë¦° ë‚´ì—­</button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#delivery">ğŸšš ë°°ì†¡ ì•Œë°”</button>
    </li>
    {% if session['is_manager'] %}
    <li class="nav-item">
        <button class="nav-link text-danger fw-bold" data-bs-toggle="tab" data-bs-target="#admin">ğŸ‘® ê´€ë¦¬ì í˜ì´ì§€</button>
    </li>
    {% endif %}
</ul>

<div class="tab-content">
    
    <div class="tab-pane fade show active" id="home">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>ëŒ€ì—¬ ê°€ëŠ¥í•œ ë¬¼í’ˆ</h4>
            
            {% if session['status'] == 'approved' %}
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registerModal">+ ë¬¼í’ˆ ë“±ë¡</button>
            {% else %}
                <span class="text-danger small">* ë§¤ë‹ˆì € ìŠ¹ì¸ í›„ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤. (í˜„ì¬ ìƒíƒœ: {{ session['status'] }})</span>
            {% endif %}
        </div>

        <div class="row">
            {% for item in items %}
            <div class="col-md-3 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <span class="badge bg-info text-dark mb-2">{{ item[2] }}</span>
                        <h5 class="card-title">{{ item[1] }}</h5>
                        <p class="card-text small text-muted">{{ item[5] }}</p>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <span class="text-primary fw-bold">{{ item[3] }} P</span>
                            <small>~ {{ item[4] }}</small>
                        </div>
                    </div>
                    <div class="card-footer bg-white border-top-0">
                        <a href="/rent/{{ item[0] }}" class="btn btn-outline-primary w-100 btn-sm">ëŒ€ì—¬ ì‹ ì²­</a>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="col-12 text-center py-5 text-muted">ë“±ë¡ëœ ë¬¼í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>
            {% endfor %}
        </div>
    </div>

    <div class="tab-pane fade" id="owner">
        <h5>ğŸ“¥ ë“¤ì–´ì˜¨ ëŒ€ì—¬ ìš”ì²­</h5>
        <table class="table table-bordered">
            <thead><tr><th>ë¬¼í’ˆ</th><th>ì‹ ì²­ì</th><th>ê¸°ê°„</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
            <tbody>
                {% for req in incoming_requests %}
                <tr>
                    <td>{{ req[1] }}</td>
                    <td>{{ req[2] }}</td>
                    <td>{{ req[3] }} ~ {{ req[4] }}</td>
                    <td><span class="badge bg-warning text-dark">{{ req[5] }}</span></td>
                    <td>
                        <a href="/approve_rental/{{ req[0] }}" class="btn btn-sm btn-success" onclick="return confirm('ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ìƒëŒ€ë°© í¬ì¸íŠ¸ ì°¨ê°)');">ìŠ¹ì¸</a>
                        <a href="/reject_rental/{{ req[0] }}" class="btn btn-sm btn-danger" onclick="return confirm('ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ê±°ì ˆ</a>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="5" class="text-center text-muted">ë“¤ì–´ì˜¨ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                {% endfor %}
            </tbody>
        </table>
        
        <h5 class="mt-4">ğŸ“¦ ë‚´ê°€ ë“±ë¡í•œ ë¬¼ê±´</h5>
        <ul class="list-group">
            {% for my in my_items %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>
                    <strong>{{ my[2] }}</strong> <span class="badge bg-light text-dark border">{{ my[3] }}</span>
                </span>
                <span class="badge bg-secondary">{{ my[7] }}</span>
            </li>
            {% endfor %}
        </ul>
    </div>

    <div class="tab-pane fade" id="borrower">
        <h5 class="mb-3">ğŸ™‹â€â™‚ï¸ ë‚´ê°€ ë¹Œë¦° ë¬¼ê±´ í˜„í™©</h5>
        <table class="table table-hover">
            <thead class="table-light"><tr><th>ë¬¼í’ˆëª…</th><th>ì†Œìœ ì</th><th>ê¸°ê°„</th><th>ìƒíƒœ</th><th>ë°°ì†¡ìƒíƒœ</th></tr></thead>
            <tbody>
                {% for rental in my_rentals %}
                <tr>
                    <td><strong>{{ rental[1] }}</strong></td> <td>{{ rental[2] }}</td> <td>{{ rental[3] }} ~ {{ rental[4] }}</td>
                    <td>
                        {% if rental[5] == 'requested' %} <span class="badge bg-warning text-dark">ìŠ¹ì¸ ëŒ€ê¸°</span>
                        {% elif rental[5] == 'approved' %} <span class="badge bg-primary">ìŠ¹ì¸ë¨</span>
                        {% elif rental[5] == 'rejected' %} <span class="badge bg-danger">ê±°ì ˆë¨</span>
                        {% else %} <span class="badge bg-info">{{ rental[5] }}</span> {% endif %}
                    </td>
                    <td>{{ rental[6] }}</td>
                </tr>
                {% else %}
                <tr><td colspan="5" class="text-center text-muted">ë¹Œë¦° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="tab-pane fade" id="delivery">
        <div class="card mb-4 border-success">
            <div class="card-header bg-success text-white fw-bold">ğŸ›µ ë‚´ ë°°ì†¡ í˜„í™©</div>
            <div class="card-body">
                {% if my_deliveries %}
                <table class="table align-middle">
                    <thead><tr><th>ë¬¼í’ˆ</th><th>ê²½ë¡œ (ì¶œë°œâ†’ë„ì°©)</th><th>ìˆ˜ìµ</th><th>ìƒíƒœ</th><th>ì•¡ì…˜</th></tr></thead>
                    <tbody>
                        {% for job in my_deliveries %}
                        <tr>
                            <td>{{ job[1] }}</td>
                            <td>{{ job[3] }}ë™ {{ job[4] }}í˜¸ â {{ job[5] }}ë™ {{ job[6] }}í˜¸</td>
                            <td class="text-success fw-bold">+{{ job[2] }} P</td>
                            <td><span class="badge bg-info">{{ job[7] }}</span></td>
                            <td>
                                {% if job[7] == 'accepted' %}
                                    <a href="/pickup_delivery/{{ job[0] }}" class="btn btn-sm btn-warning">í”½ì—…</a>
                                {% elif job[7] == 'picked_up' %}
                                    <a href="/complete_delivery/{{ job[0] }}" class="btn btn-sm btn-primary">ì™„ë£Œ</a>
                                {% else %} ì™„ë£Œë¨ {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %} <p class="text-muted">ì§„í–‰ ì¤‘ì¸ ë°°ì†¡ì´ ì—†ìŠµë‹ˆë‹¤.</p> {% endif %}
            </div>
        </div>

        <h5 class="mb-3">ğŸš€ ë°°ì†¡ ì½œ ëŒ€ê¸° ëª©ë¡</h5>
        {% if delivery_market %}
        <div class="row">
            {% for call in delivery_market %}
            <div class="col-md-4 mb-3">
                <div class="card h-100 border-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <h5 class="card-title">{{ call[1] }}</h5>
                            <span class="text-success fw-bold">{{ call[2] }} P</span>
                        </div>
                        <hr>
                        <p class="card-text mb-1">ğŸ›« <strong>ì¶œë°œ:</strong> {{ call[3] }}ë™ {{ call[4] }}í˜¸</p>
                        <p class="card-text">ğŸ›¬ <strong>ë„ì°©:</strong> {{ call[5] }}ë™ {{ call[6] }}í˜¸</p>
                        <a href="/accept_delivery/{{ call[0] }}" class="btn btn-outline-success w-100 mt-2">ìˆ˜ë½í•˜ê¸°</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %} <div class="alert alert-secondary text-center">ìš”ì²­ëœ ë°°ì†¡ì´ ì—†ìŠµë‹ˆë‹¤.</div> {% endif %}
    </div>

    <div class="tab-pane fade" id="admin">
        
        <div class="row mb-4">
            <!-- A. ê°€ì… ìŠ¹ì¸ ëŒ€ê¸° (ì™¼ìª½) -->
            <div class="col-md-6">
                <div class="card h-100 border-primary">
                    <div class="card-header bg-primary text-white fw-bold">
                        ğŸ“ ì‹ ê·œ ê°€ì… ìš”ì²­ (ëŒ€ê¸°ì¤‘)
                    </div>
                    <ul class="list-group list-group-flush">
                        {% for user in pending_residents %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ user[2] }}</strong> ({{ user[4] }}ë™ {{ user[5] }}í˜¸)<br>
                                <span class="text-muted small">ID: {{ user[1] }} / ğŸ“ {{ user[3] }}</span>
                            </div>
                            <div>
                                <a href="/approve_resident/{{ user[0] }}" class="btn btn-sm btn-success">ìŠ¹ì¸</a>
                                <a href="/reject_resident/{{ user[0] }}" class="btn btn-sm btn-danger">ê±°ì ˆ</a>
                            </div>
                        </li>
                        {% else %}
                        <li class="list-group-item text-center text-muted py-3">ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <!-- B. ë¶„ìŸ ê´€ë¦¬ (ì˜¤ë¥¸ìª½) -->
            <div class="col-md-6">
                <div class="card h-100 border-danger">
                    <div class="card-header bg-danger text-white fw-bold">
                        âš–ï¸ ë¶„ìŸ ì‹ ê³  ê´€ë¦¬
                    </div>
                    <div class="card-body">
                        {% if open_disputes %}
                        <table class="table table-sm">
                            <thead><tr><th>ì‹ ê³ ë‚´ìš©</th><th>ë‹¹ì‚¬ì</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody>
                                {% for d in open_disputes %}
                                <tr>
                                    <td>{{ d[2] }}</td>
                                    <td>{{ d[3] }} vs {{ d[4] }}</td>
                                    <td><button class="btn btn-sm btn-outline-danger">íŒê²°</button></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <p class="text-muted text-center mt-3">í˜„ì¬ ì ‘ìˆ˜ëœ ë¶„ìŸì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <hr>

        <!-- C. [ì‹ ê·œ] íšŒì› ê´€ë¦¬ ì´ë ¥ ë° ê²€ìƒ‰ -->
        <div class="card border-secondary">
            <div class="card-header bg-secondary text-white fw-bold d-flex justify-content-between align-items-center">
                <span>ğŸ‘¥ ì „ì²´ ì£¼ë¯¼ ê´€ë¦¬ (ì²˜ë¦¬ ì´ë ¥)</span>
            </div>
            <div class="card-body">
                <!-- ê²€ìƒ‰ ë° í•„í„° í¼ -->
                <form method="GET" action="/" class="row g-2 mb-3 align-items-center">
                    <!-- í¼ ì œì¶œ ì‹œ íƒ­ ìœ ì§€ë¥¼ ìœ„í•´ hidden inputì´ë‚˜ JSê°€ í•„ìš”í•  ìˆ˜ ìˆìœ¼ë‚˜, ì—¬ê¸°ì„  ê¸°ë³¸ ë™ì‘ -->
                    <input type="hidden" name="tab" value="admin"> 
                    
                    <div class="col-auto">
                        <select name="f" class="form-select form-select-sm">
                            <option value="all" {% if filter_status == 'all' %}selected{% endif %}>ì „ì²´ ë³´ê¸°</option>
                            <option value="approved" {% if filter_status == 'approved' %}selected{% endif %}>âœ… ìŠ¹ì¸ë¨</option>
                            <option value="rejected" {% if filter_status == 'rejected' %}selected{% endif %}>ğŸš« ê±°ì ˆë¨</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <input type="text" name="q" class="form-control form-control-sm" placeholder="ì´ë¦„ ë˜ëŠ” ID ê²€ìƒ‰" value="{{ search_query }}">
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-sm btn-dark">ê²€ìƒ‰</button>
                        <a href="/" class="btn btn-sm btn-outline-secondary">ì´ˆê¸°í™”</a>
                    </div>
                </form>

                <!-- ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸” -->
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>ì´ë¦„ (í˜¸ìˆ˜)</th>
                                <th>ì „í™”ë²ˆí˜¸</th>
                                <th>í˜„ì¬ ìƒíƒœ</th>
                                <th>ìƒíƒœ ë³€ê²½ (ë˜ëŒë¦¬ê¸°)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in history_residents %}
                            <tr>
                                <td>{{ user[1] }}</td>
                                <td>{{ user[2] }} <small class="text-muted">({{ user[4] }}ë™ {{ user[5] }}í˜¸)</small></td>
                                <td>{{ user[3] }}</td>
                                <td>
                                    {% if user[6] == 'approved' %}
                                        <span class="badge bg-success">ìŠ¹ì¸ë¨</span>
                                    {% else %}
                                        <span class="badge bg-dark">ê±°ì ˆ(ì •ì§€)ë¨</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user[6] == 'approved' %}
                                        <!-- ìŠ¹ì¸ëœ ì‚¬ëŒì€ -> ê±°ì ˆ(ì •ì§€) ì‹œí‚¤ê¸° -->
                                        <a href="/reject_resident/{{ user[0] }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('ì´ ì£¼ë¯¼ì˜ í™œë™ì„ ì •ì§€(ê±°ì ˆ)ì‹œí‚¤ê² ìŠµë‹ˆê¹Œ?');">ì •ì§€í•˜ê¸°</a>
                                    {% else %}
                                        <!-- ê±°ì ˆëœ ì‚¬ëŒì€ -> ìŠ¹ì¸ or ëŒ€ê¸° ë³µêµ¬ -->
                                        <a href="/approve_resident/{{ user[0] }}" class="btn btn-sm btn-outline-success" onclick="return confirm('ë‹¤ì‹œ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì¬ìŠ¹ì¸</a>
                                        <a href="/restore_resident/{{ user[0] }}" class="btn btn-sm btn-outline-secondary">ëŒ€ê¸°ë¡œ ë³µêµ¬</a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="5" class="text-center py-3 text-muted">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

<div class="modal fade" id="registerModal" tabindex="-1">
    <div class="modal-dialog">
        <form action="/register_item" method="POST">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ“¦ ë‚´ ë¬¼ê±´ ë“±ë¡í•˜ê¸°</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label fw-bold">ë¬¼í’ˆëª…</label>
                    <input type="text" name="name" class="form-control mb-3" placeholder="ì˜ˆ: ì „ë™ë“œë¦´" required>
                    
                    <label class="form-label fw-bold">ì¹´í…Œê³ ë¦¬</label>
                    <select name="category" class="form-select mb-3">
                        <option value="ê³µêµ¬/ìˆ˜ë¦¬">ğŸ”§ ê³µêµ¬/ìˆ˜ë¦¬</option>
                        <option value="ìº í•‘/ë ˆì €">â›º ìº í•‘/ë ˆì €</option>
                        <option value="ìœ¡ì•„/ì¥ë‚œê°">ğŸ§¸ ìœ¡ì•„/ì¥ë‚œê°</option>
                        <option value="ì£¼ë°©/ìƒí™œ">ğŸ³ ì£¼ë°©/ìƒí™œ</option>
                        <option value="ì „ìê¸°ê¸°">ğŸ’» ì „ìê¸°ê¸°</option>
                        <option value="ë„ì„œ/ì·¨ë¯¸">ğŸ“š ë„ì„œ/ì·¨ë¯¸</option>
                        <option value="ê¸°íƒ€">ğŸ¸ ê¸°íƒ€</option>
                    </select>
                    
                    <label class="form-label fw-bold">ìƒì„¸ ì„¤ëª…</label>
                    <textarea name="description" class="form-control mb-3" rows="3" placeholder="ìƒì„¸ ì„¤ëª…"></textarea>
                    
                    <label class="form-label fw-bold">1ì¼ ëŒ€ì—¬ë£Œ (í¬ì¸íŠ¸)</label>
                    <div class="input-group mb-3">
                        <input type="number" name="rent_fee" class="form-control" placeholder="0" min="0" required>
                        <span class="input-group-text">P / 1ì¼</span>
                    </div>

                    <label class="form-label fw-bold">ê³µìœ  ë§ˆê°ì¼</label>
                    <input type="date" name="expiration_date" class="form-control" min="{{ date_today }}" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ë“±ë¡í•˜ê¸°</button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}
{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center mt-4">
    <div class="col-md-5">
        <div class="card shadow-sm">
            <div class="card-header bg-transparent border-0 mt-2">
                <span class="badge bg-info text-dark">{{ item[3] }}</span>
                <h3 class="mt-2">{{ item[2] }}</h3>
            </div>
            <div class="card-body">
                <h5 class="text-primary fw-bold mb-3">ğŸ’° 1ì¼ ëŒ€ì—¬ë£Œ: {{ item[5] }} P</h5>
                <p class="card-text text-muted" style="white-space: pre-line;">{{ item[4] }}</p>
                <hr>
                <ul class="list-unstyled">
                    <li class="mb-2">ğŸ“… <strong>ê³µìœ  ë§ˆê°ì¼:</strong> {{ item[6] }}</li>
                    <li class="mb-2">ğŸ‘¤ <strong>ì†Œìœ ì ID:</strong> {{ item[1] }}</li>
                    <li class="mb-2 text-success">ğŸ’° <strong>ë‚´ ì”ê³ :</strong> {{ my_points }} P</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card shadow-sm border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">ğŸ“ ëŒ€ì—¬ ì‹ ì²­ì„œ ì‘ì„±</h5>
            </div>
            <div class="card-body">
                <form method="POST" id="rentForm">
                    
                    <div class="mb-4">
                        <label class="form-label fw-bold">ëŒ€ì—¬ ê¸°ê°„</label>
                        <div class="input-group mb-2">
                            <span class="input-group-text">ì‹œì‘ì¼</span>
                            <input type="date" name="start_date" id="startDate" class="form-control" 
                                   min="{{ date_today }}" max="{{ item[6] }}" required onchange="calculateTotal()">
                        </div>
                        <div class="input-group">
                            <span class="input-group-text">ë°˜ë‚©ì¼</span>
                            <input type="date" name="end_date" id="endDate" class="form-control" 
                                   min="{{ date_today }}" max="{{ item[6] }}" required onchange="calculateTotal()">
                        </div>
                        <div class="form-text text-danger" id="dateAlert" style="display:none;">
                            ë°˜ë‚©ì¼ì€ ì‹œì‘ì¼ë³´ë‹¤ ë¹ ë¥¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">ìˆ˜ë ¹ ë°©ì‹</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="delivery_option" id="pickup" value="pickup" checked onchange="calculateTotal()">
                            <label class="btn btn-outline-secondary" for="pickup">ğŸ¤ ì§ê±°ë˜ (ë¬´ë£Œ)</label>

                            <input type="radio" class="btn-check" name="delivery_option" id="delivery" value="delivery" onchange="calculateTotal()">
                            <label class="btn btn-outline-secondary" for="delivery">ğŸšš ë°°ì†¡ ëŒ€í–‰ (+500 P)</label>
                        </div>
                    </div>

                    <hr>

                    <div class="alert alert-light border text-center">
                        <p class="mb-1">ì´ ëŒ€ì—¬ ê¸°ê°„: <strong id="totalDays">0</strong>ì¼</p>
                        <h4>ì´ ê²°ì œ í¬ì¸íŠ¸: <span id="totalPrice" class="text-primary">0</span> P</h4>
                        <p id="balanceAlert" class="text-danger fw-bold mt-2" style="display:none;">âŒ ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!</p>
                        <small class="text-muted">(ëŒ€ì—¬ ìŠ¹ì¸ ì‹œ í¬ì¸íŠ¸ê°€ ì°¨ê°ë©ë‹ˆë‹¤)</small>
                    </div>

                    <button type="submit" id="submitBtn" class="btn btn-primary w-100 btn-lg" disabled>ì‹ ì²­í•˜ê¸°</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Python ë³€ìˆ˜ë¥¼ JS ìƒìˆ˜ë¡œ ê°€ì ¸ì˜´
    const rentFee = Number("{{ item[5] }}"); 
    const myPoints = Number("{{ my_points }}");

    function calculateTotal() {
        const startVal = document.getElementById('startDate').value;
        const endVal = document.getElementById('endDate').value;
        const dateAlert = document.getElementById('dateAlert');
        const balanceAlert = document.getElementById('balanceAlert');
        const submitBtn = document.getElementById('submitBtn');
        const isDelivery = document.getElementById('delivery').checked;
        
        // ë°°ì†¡ë¹„ ì„¤ì •
        const deliveryFee = isDelivery ? 500 : 0;

        if (startVal && endVal) {
            const start = new Date(startVal);
            const end = new Date(endVal);
            
            const diffTime = end - start;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

            // 1. ë‚ ì§œ ìœ íš¨ì„± ì²´í¬
            if (diffDays <= 0) {
                dateAlert.style.display = 'block';
                document.getElementById('totalDays').innerText = 0;
                document.getElementById('totalPrice').innerText = 0;
                submitBtn.disabled = true;
                balanceAlert.style.display = 'none';
                return;
            } else {
                dateAlert.style.display = 'none';
                document.getElementById('totalDays').innerText = diffDays;
                
                // 2. ì´ì•¡ ê³„ì‚°
                const total = (diffDays * rentFee) + deliveryFee;
                document.getElementById('totalPrice').innerText = total.toLocaleString();

                // 3. ì”ì•¡ ë¹„êµ (í•µì‹¬ ê¸°ëŠ¥)
                if (total > myPoints) {
                    balanceAlert.style.display = 'block'; // ê²½ê³  í‘œì‹œ
                    document.getElementById('totalPrice').classList.add('text-danger');
                    submitBtn.disabled = true; // ë²„íŠ¼ ë¹„í™œì„±í™”
                } else {
                    balanceAlert.style.display = 'none';
                    document.getElementById('totalPrice').classList.remove('text-danger');
                    submitBtn.disabled = false; // ë²„íŠ¼ í™œì„±í™”
                }
            }
        } else {
            // ë‚ ì§œ ì„ íƒ ì•ˆë¨
            submitBtn.disabled = true;
        }
    }
</script>
{% endblock %}